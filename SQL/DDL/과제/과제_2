--1.
CREATE TABLE MEMBER
(
	MEMBER_ID	NUMBER(10)		PRIMARY KEY,
	NAME		VARCHAR2(25)	NOT NULL,
	ADDRESS		VARCHAR2(100),
	CITY		VARCHAR2(30),
	PHONE		VARCHAR2(15),
	JOIN_DATE	DATE	DEFAULT SYSDATE	NOT NULL
);

CREATE TABLE TITLE
(
	TITLE_ID	NUMBER(10)		PRIMARY KEY,
	TITLE		VARCHAR2(60)	NOT NULL,
	DESCRIPTION	VARCHAR2(400)	NOT NULL,
	RATING		VARCHAR2(20),
	CATEGORY	VARCHAR2(20),
	RELEASE_DATE	DATE,
	CONSTRAINT RATING_CHK	CHECK(RATING IN ('18가','15가','12가','전체가')),
	CONSTRAINT CATEGORY_CHK	CHECK(CATEGORY IN ('드라마','코미디','액션','아동','SF','다큐멘터리'))
);

CREATE TABLE TITLE_COPY
(
	COPY_ID		NUMBER(10),
	TITLE_ID	NUMBER(10),
	STATUS		VARCHAR2(20) NOT NULL,
	CONSTRAINT TC_PK PRIMARY KEY(COPY_ID,TITLE_ID),
	CONSTRAINT TC_FK FOREIGN KEY (TITLE_ID) REFERENCES TITLE(TITLE_ID),
	CONSTRAINT STATUS_CHK	CHECK(STATUS IN ('대여가능','파손','대여중','예약'))
);

CREATE TABLE RESERVATION
(
	RES_DATE	DATE,
	MEMBER_ID	NUMBER(10),
	TITLE_ID	NUMBER(10),
	CONSTRAINT RES_PK	PRIMARY KEY(RES_DATE,MEMBER_ID,TITLE_ID),
	CONSTRAINT RES_FK1	FOREIGN KEY(MEMBER_ID) REFERENCES MEMBER(MEMBER_ID),
	CONSTRAINT RES_FK2	FOREIGN KEY(TITLE_ID)	REFERENCES TITLE(TITLE_ID)
);

CREATE TABLE RENTAL
(
	BOOK_DATE	DATE	DEFAULT SYSDATE,
	MEMBER_ID	NUMBER(10),
	COPY_ID		NUMBER(10),
	TITLE_ID	NUMBER(10),
	ACT_RET_DATE	DATE,
	EXP_RET_DATE	DATE	DEFAULT SYSDATE+2,
	CONSTRAINT RNT_PK	PRIMARY KEY(BOOK_DATE,MEMBER_ID,TITLE_ID,COPY_ID),
	CONSTRAINT RNT_FK1	FOREIGN KEY(MEMBER_ID) REFERENCES MEMBER(MEMBER_ID),
	CONSTRAINT RNT_FK2	FOREIGN KEY(TITLE_ID,COPY_ID)	REFERENCES TITLE_COPY(TITLE_ID,COPY_ID)
);

--2.
CREATE SEQUENCE MEMBER_ID_SEQ
START WITH 101
NOCACHE

CREATE SEQUENCE TITLE_ID_SEQ
START WITH 92
NOCACHE

--3.
INSERT INTO TITLE
VALUES(TITLE_ID_SEQ.NEXTVAL, '인어공주','인어공주 설명','전체가','아동','95/10/05');
INSERT INTO TITLE
VALUES(TITLE_ID_SEQ.NEXTVAL, '매트릭스',
'매트릭스 설명',
'15가',
'SF',
'95/05/19');
INSERT INTO TITLE
VALUES(TITLE_ID_SEQ.NEXTVAL,
'에이리언',
'에이리언 설명',
'18가',
'SF',
'95/08/12'
);
INSERT INTO TITLE
VALUES(TITLE_ID_SEQ.NEXTVAL,
'모던타임즈',
'모던타임즈 설명',
'전체가',
'코미디',
'95/07/12'
);
INSERT INTO TITLE
VALUES(TITLE_ID_SEQ.NEXTVAL,
'러브스토리',
'러브스토리 설명',
'전체가',
'드라마',
'95/09/12'
);
INSERT INTO TITLE
VALUES(TITLE_ID_SEQ.NEXTVAL,
'람보',
'람보 설명',
'18가',
'액션',
'95/06/01'
);

--4.
INSERT INTO MEMBER
VALUES(MEMBER_ID_SEQ.NEXTVAL,
'김철수',
'강남구',
'서울',
'899-6666',
'90/03/08'
);
INSERT INTO MEMBER
VALUES(MEMBER_ID_SEQ.NEXTVAL,
'이영희',
'서면',
'부산',
'355-8882',
'90/03/08'
);
INSERT INTO MEMBER
VALUES(MEMBER_ID_SEQ.NEXTVAL,
'최진국',
'동광양',
'제주',
'852-5764',
'91/06/17'
);
INSERT INTO MEMBER
VALUES(MEMBER_ID_SEQ.NEXTVAL,
'강준호',
'홍제동',
'강릉',
'559-7777',
'90/04/07'
);
INSERT INTO MEMBER
VALUES(MEMBER_ID_SEQ.NEXTVAL,
'민병국',
'전민동',
'대전',
'559-8741',
'91/01/18'
);
INSERT INTO MEMBER
VALUES(MEMBER_ID_SEQ.NEXTVAL,
'오민수',
'북구',
'광주',
'542-9988',
'91/01/18'
);

--5.
INSERT INTO TITLE_COPY
(
	SELECT 1,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '인어공주'
);
INSERT INTO TITLE_COPY
(
	SELECT 1,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '매트릭스'
);
INSERT INTO TITLE_COPY
(
	SELECT 2,TITLE_ID,'대여중'
	FROM TITLE
	WHERE TITLE = '매트릭스'
);

INSERT INTO TITLE_COPY
(
	SELECT 1,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '에이리언'
);
INSERT INTO TITLE_COPY
(
	SELECT 1,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '모던타임즈'
);
INSERT INTO TITLE_COPY
(
	SELECT 2,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '모던타임즈'
);
INSERT INTO TITLE_COPY
(
	SELECT 3,TITLE_ID,'대여중'
	FROM TITLE
	WHERE TITLE = '모던타임즈'
);
INSERT INTO TITLE_COPY
(
	SELECT 1,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '러브스토리'
);
INSERT INTO TITLE_COPY
(
	SELECT 1,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '람보'
);

--6.
INSERT INTO RENTAL
(
	SELECT SYSDATE-3,M.MEMBER_ID,TC.COPY_ID,TC.TITLE_ID, SYSDATE-2,SYSDATE-1
	FROM MEMBER M, TITLE_COPY TC
	WHERE M.MEMBER_ID = (SELECT MEMBER_ID FROM MEMBER WHERE NAME = '김철수') AND
	TC.TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '인어공주')
);

INSERT INTO RENTAL(book_date,member_id,copy_id,title_id,exp_ret_date)
(
	SELECT SYSDATE-1,M.MEMBER_ID,TC.COPY_ID,TC.TITLE_ID,SYSDATE+1
	FROM MEMBER M, TITLE_COPY TC
	WHERE M.MEMBER_ID = (SELECT MEMBER_ID FROM MEMBER WHERE NAME = '최진국') AND
	TC.TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '매트릭스' AND STATUS = '대여중')
);

INSERT INTO RENTAL(book_date,member_id,copy_id,title_id,exp_ret_date)
(
	SELECT SYSDATE-2,M.MEMBER_ID,TC.COPY_ID,TC.TITLE_ID,SYSDATE
	FROM MEMBER M, TITLE_COPY TC
	WHERE M.MEMBER_ID = (SELECT MEMBER_ID FROM MEMBER WHERE NAME = '강준호') AND
	TC.TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '모던타임즈' AND STATUS = '대여중')
);

INSERT INTO RENTAL
(
	SELECT SYSDATE-4,M.MEMBER_ID,TC.COPY_ID,TC.TITLE_ID, SYSDATE-2,SYSDATE-2
	FROM MEMBER M, TITLE_COPY TC
	WHERE M.MEMBER_ID = (SELECT MEMBER_ID FROM MEMBER WHERE NAME = '민병국') AND
	TC.TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '람보')
);

--7.
CREATE OR REPLACE VIEW TITLE_AVAIL
AS
	SELECT	T.TITLE,TC.COPY_ID,TC.STATUS,R.EXP_RET_DATE
	FROM TITLE_COPY TC
	JOIN TITLE T ON (TC.TITLE_ID = T.TITLE_ID)
	LEFT JOIN RENTAL R ON (TC.TITLE_ID = R.TITLE_ID AND TC.COPY_ID = R.COPY_ID)
	
--8.
INSERT INTO TITLE
VALUES(TITLE_ID_SEQ.NEXTVAL, '스타워즈',
'스타워즈 설명',
'전체가',
'SF',
'77/07/07');

INSERT INTO TITLE_COPY
(
	SELECT 1,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '스타워즈'
);

INSERT INTO TITLE_COPY
(
	SELECT 2,TITLE_ID,'대여가능'
	FROM TITLE
	WHERE TITLE = '스타워즈'
);

INSERT INTO RESERVATION(RES_DATE,MEMBER_ID,TITLE_ID)
(
	SELECT SYSDATE,M.MEMBER_ID,T.TITLE_ID
	FROM MEMBER M, TITLE T
	WHERE M.MEMBER_ID = (SELECT MEMBER_ID FROM MEMBER WHERE NAME = '이영희')
	AND T.TITLE_ID = 
	(
		SELECT TITLE_ID
		FROM TITLE_COPY
		JOIN TITLE 
		USING(TITLE_ID) 
		WHERE TITLE = '스타워즈'
	)
);

INSERT INTO RESERVATION(RES_DATE,MEMBER_ID,TITLE_ID)
(
	SELECT SYSDATE,M.MEMBER_ID,T.TITLE_ID
	FROM MEMBER M, TITLE T
	WHERE M.MEMBER_ID = (SELECT MEMBER_ID FROM MEMBER WHERE NAME = '오민수')
	AND T.TITLE_ID = 
	(
		SELECT TITLE_ID
		FROM TITLE_COPY
		JOIN TITLE 
		USING(TITLE_ID) 
		WHERE TITLE = '러브스토리'
	)
);

DELETE FROM RESERVATION
WHERE MEMBER_ID = (SELECT MEMBER_ID FROM MEMBER WHERE NAME = '이영희');

UPDATE TITLE_COPY SET STATUS = '대여중'
WHERE TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '스타워즈') AND COPY_ID = 1;

INSERT INTO RENTAL(exp_ret_date,member_id,copy_id,title_id)
(
	SELECT SYSDATE+2, M.MEMBER_ID,TC.COPY_ID,TC.TITLE_ID
	FROM MEMBER M, TITLE_COPY TC
	WHERE M.MEMBER_ID = (SELECT MEMBER_ID FROM MEMBER WHERE NAME = '이영희') AND
	TC.TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '스타워즈') AND TC.COPY_ID = 1
);

SELECT * FROM TITLE_AVAIL

--9.
ALTER TABLE TITLE DROP(PRICE)
ALTER TABLE TITLE ADD(PRICE NUMBER(5) DEFAULT 0);
ALTER TABLE TITLE MODIFY(PRICE CONSTRAINT PRICE_NN NOT NULL);
UPDATE TITLE SET PRICE = 3000
WHERE TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '인어공주');
UPDATE TITLE SET PRICE = 2500
WHERE TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '매트릭스');
UPDATE TITLE SET PRICE = 2000
WHERE TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '에이리언');
UPDATE TITLE SET PRICE = 3000
WHERE TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '모던타임즈');
UPDATE TITLE SET PRICE = 3500
WHERE TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '러브스토리');
UPDATE TITLE SET PRICE = 2000
WHERE TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '람보');
UPDATE TITLE SET PRICE = 1500
WHERE TITLE_ID = (SELECT TITLE_ID FROM TITLE WHERE TITLE = '스타워즈');

--10.
SELECT NAME AS 회원명, TITLE AS 제목, TO_CHAR(BOOK_DATE,'YYYY/MM/DD') AS 대여일, RENT_DATE AS 기간
FROM RENTAL
JOIN MEMBER USING(MEMBER_ID)
JOIN TITLE USING(TITLE_ID)
LEFT JOIN
(
	SELECT MEMBER_ID, 
		(
			(TO_NUMBER(TO_CHAR(ACT_RET_DATE,'YYYY') - TO_NUMBER(TO_CHAR(BOOK_DATE,'YYYY')))) * 365 + 
			(TO_NUMBER(TO_CHAR(ACT_RET_DATE,'MM')) - TO_NUMBER(TO_CHAR(BOOK_DATE,'MM'))) * 30 +
			(TO_NUMBER(TO_CHAR(ACT_RET_DATE,'DD')) - TO_NUMBER(TO_CHAR(BOOK_DATE,'DD')))
		) AS RENT_DATE
	FROM RENTAL
	WHERE ACT_RET_DATE IS NOT NULL
) USING(MEMBER_ID);
