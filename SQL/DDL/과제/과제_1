-- 1.
CREATE TABLE CUSTOMERS
(
	CNO		NUMBER(5) CONSTRAINT CPRIMARY PRIMARY KEY,
	CNAME 	VARCHAR2(10) NOT NULL,
	ADDRESS	VARCHAR2(50) NOT NULL,
	EMAIL	VARCHAR2(20) NOT NULL,
	PHONE	VARCHAR2(20) NOT NULL
);

CREATE TABLE ORDERS
(
	ORDERNO NUMBER(10) PRIMARY KEY,
	ORDERDATE	DATE	DEFAULT SYSDATE,
	ADDRESS		VARCHAR2(50) NOT NULL,
	PHONE		VARCHAR2(20) NOT NULL,
	STATUS		VARCHAR2(20) NOT NULL,
	CNO			NUMBER(5) REFERENCES CUSTOMERS(CNO),
	CONSTRAINT CHK_STATUS CHECK (STATUS IN ('결제완료','배송중','배송완료'))
);

CREATE TABLE PRODUCTS
(
	PNO		NUMBER(5),
	PNAME	VARCHAR2(20) CONSTRAINT PNAME_NN NOT NULL,
	COST	NUMBER(8) CONSTRAINT COST_NN NOT NULL,
	STOCK	NUMBER(5) CONSTRAINT STOCK_NN NOT NULL,
	CONSTRAINT P_PK PRIMARY KEY (PNO)
);

CREATE TABLE ORDERDETAIL
(
	ORDERNO NUMBER(10),
	PNO		NUMBER(5),
	QTY		NUMBER(5) DEFAULT 0,
	COST	NUMBER(8) DEFAULT 0,
	CONSTRAINT OD_PK PRIMARY KEY (ORDERNO,PNO),
	CONSTRAINT OD_FK1 FOREIGN KEY (ORDERNO) REFERENCES ORDERS(ORDERNO),
	CONSTRAINT OD_FK2 FOREIGN KEY (PNO) REFERENCES PRODUCTS(PNO)
);

--2.
INSERT INTO PRODUCTS(PNO, PNAME, COST, STOCK)
VALUES(1001,'삼양라면','1000','200');
INSERT INTO PRODUCTS(PNO, PNAME, COST, STOCK)
VALUES(1002,'새우깡','1500','500');
INSERT INTO PRODUCTS(PNO, PNAME, COST, STOCK)
VALUES(1003,'월드콘','2000','350');
INSERT INTO PRODUCTS(PNO, PNAME, COST, STOCK)
VALUES(1004,'빼빼로','2000','700');
INSERT INTO PRODUCTS(PNO, PNAME, COST, STOCK)
VALUES(1005,'코카콜라','1800','550');
INSERT INTO PRODUCTS(PNO, PNAME, COST, STOCK)
VALUES(1006,'환타','1600','300');

--3.
CREATE SEQUENCE CNO_SEQ
START WITH 101
INCREMENT BY 1;

INSERT INTO CUSTOMERS(CNO, CNAME, ADDRESS, EMAIL,PHONE)
VALUES(CNO_SEQ.NEXTVAL,'김철수', '서울 강남구','CSKIM@NAVER.COM','899-6666');

INSERT INTO CUSTOMERS(CNO, CNAME, ADDRESS, EMAIL,PHONE)
VALUES(CNO_SEQ.NEXTVAL,'이영희', '부산 서면','YHLEE@EMPAL.COM','355-8882');

INSERT INTO CUSTOMERS(CNO, CNAME, ADDRESS, EMAIL,PHONE)
VALUES(CNO_SEQ.NEXTVAL,'최진국','제주 동광양','jkchoi@gmail.com','852-5764');

INSERT INTO CUSTOMERS(CNO, CNAME, ADDRESS, EMAIL,PHONE)
VALUES(CNO_SEQ.NEXTVAL, '강준호', '강릉 홍제동','jhkang@hanmail.com','559-7777');

INSERT INTO CUSTOMERS(CNO, CNAME, ADDRESS, EMAIL,PHONE)
VALUES(CNO_SEQ.NEXTVAL,'민병국','대전 전민동','bgmin@hotmail.com','559-8741');

INSERT INTO CUSTOMERS(CNO, CNAME, ADDRESS, EMAIL,PHONE)
VALUES(CNO_SEQ.NEXTVAL,'오민수','광주 북구','msoh@microsoft.com','542-9988');

--4.
CREATE SEQUENCE ORDERNO

INSERT INTO ORDERS(ORDERNO, ORDERDATE,STATUS, ADDRESS, PHONE,CNO)
(
	SELECT 	ORDERNO.NEXTVAL, SYSDATE-3,'결제완료',ADDRESS,PHONE,CNO
	FROM	CUSTOMERS
	WHERE	CNAME = '김철수'
);

INSERT INTO ORDERDETAIL(ORDERNO, PNO, QTY, COST)
(
	SELECT ORDERNO, PNO, 50, COST
	FROM ORDERS
	JOIN PRODUCTS ON (PNO = 1001)
	WHERE CNO = 
		(
			SELECT 	CNO
			FROM	CUSTOMERS
			WHERE	CNAME = '김철수'
		)	
);

--5.
UPDATE PRODUCTS SET STOCK  = STOCK - 50
WHERE PNO = 1001

--6.
INSERT INTO ORDERS(ORDERNO, ORDERDATE,STATUS, ADDRESS, PHONE,CNO)
(
	SELECT 	ORDERNO.NEXTVAL, SYSDATE-2,'결제완료',ADDRESS,PHONE,CNO
	FROM	CUSTOMERS
	WHERE	CNAME = '이영희'
);

INSERT ALL INTO ORDERDETAIL(ORDERNO, PNO, QTY, COST)
(
	SELECT ORDERNO, PNO, 100, COST
	FROM ORDERS
	JOIN PRODUCTS ON (PNO = 1002)
	WHERE CNO = 
		(
			SELECT 	CNO
			FROM	CUSTOMERS
			WHERE	CNAME = '이영희'
		)	
);

INSERT ALL INTO ORDERDETAIL(ORDERNO, PNO, QTY, COST)
(
	SELECT ORDERNO, PNO, 150, COST
	FROM ORDERS
	JOIN PRODUCTS ON (PNO = 1003)
	WHERE CNO = 
		(
			SELECT 	CNO
			FROM	CUSTOMERS
			WHERE	CNAME = '이영희'
		)	
);

--7.
UPDATE PRODUCTS SET STOCK  = STOCK - 100
WHERE PNO = 1002;

UPDATE PRODUCTS SET STOCK  = STOCK - 150
WHERE PNO = 1003;

--8.
INSERT INTO ORDERS(ORDERNO, ORDERDATE,STATUS, ADDRESS, PHONE,CNO)
(
	SELECT 	ORDERNO.NEXTVAL, SYSDATE-1,'결제완료',ADDRESS,PHONE,CNO
	FROM	CUSTOMERS
	WHERE	CNAME = '오민수'
);

INSERT ALL INTO ORDERDETAIL(ORDERNO, PNO, QTY, COST)
(
	SELECT ORDERNO, PNO, 100, COST
	FROM ORDERS
	JOIN PRODUCTS ON (PNO = 1004)
	WHERE CNO = 
		(
			SELECT 	CNO
			FROM	CUSTOMERS
			WHERE	CNAME = '오민수'
		)	
);

INSERT ALL INTO ORDERDETAIL(ORDERNO, PNO, QTY, COST)
(
	SELECT ORDERNO, PNO, 50, COST
	FROM ORDERS
	JOIN PRODUCTS ON (PNO = 1005)
	WHERE CNO = 
		(
			SELECT 	CNO
			FROM	CUSTOMERS
			WHERE	CNAME = '오민수'
		)	
);

--9.
UPDATE PRODUCTS SET STOCK  = STOCK - 100
WHERE PNO = 1004;

UPDATE PRODUCTS SET STOCK  = STOCK - 50
WHERE PNO = 1005;

--10.
SELECT O.ORDERDATE,C.CNAME,O.ADDRESS,O.PHONE,O.STATUS,P.PNAME,P.COST,OD.QTY, P.COST*OD.QTY
FROM ORDERS O
JOIN ORDERDETAIL OD USING(ORDERNO)
JOIN PRODUCTS P USING(PNO)
JOIN CUSTOMERS C USING(CNO)
ORDER BY O.ORDERDATE ASC;

--11.
SELECT O.ORDERDATE,SUM(P.COST*OD.QTY)
FROM ORDERS O
JOIN ORDERDETAIL OD USING(ORDERNO)
JOIN PRODUCTS P USING(PNO)
JOIN CUSTOMERS C USING(CNO)
GROUP BY O.ORDERDATE
ORDER BY O.ORDERDATE ASC;

--12.
INSERT INTO PRODUCTS
VALUES(1007,'목캔디',3000,500)

--13.
INSERT INTO ORDERS(ORDERNO, ORDERDATE,STATUS, ADDRESS, PHONE,CNO)
(
	SELECT 	ORDERNO.NEXTVAL, SYSDATE,'결제완료','제주 동광양','352-4657',CNO
	FROM	CUSTOMERS
	WHERE	CNAME = '최진국'
);

INSERT ALL INTO ORDERDETAIL(ORDERNO, PNO, QTY, COST)
(
	SELECT ORDERNO, PNO, 200, COST
	FROM ORDERS
	JOIN PRODUCTS ON (PNO = 1007)
	WHERE CNO = 
		(
			SELECT 	CNO
			FROM	CUSTOMERS
			WHERE	CNAME = '최진국'
		)	
);

UPDATE PRODUCTS SET STOCK  = STOCK - 200
WHERE PNO = 1007;
